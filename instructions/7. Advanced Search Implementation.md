# Plan 07 — Advanced Search Implementation

## Goal

Implement powerful search capabilities allowing users to find documents by:

- Content (OCR text)
- Date ranges
- Categories
- Companies
- Tags
- Combinations of the above

Example: "Find all stock_overview documents containing 'Apple' from 2022-2025"

---

## Core Principles

- Fast queries (<100ms for most searches)
- Intuitive query syntax
- Fuzzy matching for typos
- Faceted filtering (filter-as-you-type)
- Search results include snippets/highlights

---

## Technology Stack

- Primary: **PostgreSQL full-text search** (built-in)
- Query parsing: Custom parser for search syntax
- Highlighting: `ts_headline` function
- Future: Semantic search via **pgvector** extension (embeddings)

---

## Search Query Syntax

### Basic Full-Text Search

```
"Apple Inc"
```

Searches OCR text for "Apple Inc"

### Date Range Filter

```
date:2022-2025 Apple
```

Documents with extracted_date between 2022-2025 containing "Apple"

### Category Filter

```
category:stock_overview Apple
```

Only stock_overview documents

### Combined Filters

```
category:stock_overview date:2023 "dividend payment"
```

Stock overview documents from 2023 containing "dividend payment"

### Company Filter

```
company:Apple OR company:Microsoft
```

Documents mentioning either company

### Tag Filter

```
tag:important tag:tax-related
```

Documents with both tags

---

## Search Architecture

### Query Parser

Converts user query into structured search object:

```typescript
interface ParsedQuery {
    fullText?: string; // Free-text search terms
    dateRange?: {
        start?: Date;
        end?: Date;
    };
    categories?: string[];
    companies?: string[];
    tags?: string[];
    folders?: string[]; // Folder path filter
}
```

### SQL Query Builder

Generates efficient PostgreSQL queries:

```sql
SELECT
  d.id,
  d.original_filename,
  d.extracted_date,
  d.document_category,
  ocr.raw_text,
  ts_headline('english', ocr.raw_text, query, 'MaxWords=50, MinWords=25') as snippet,
  ts_rank(ocr.text_vector, query) as relevance
FROM documents d
JOIN ocr_results ocr ON ocr.document_id = d.id
WHERE
  ocr.text_vector @@ to_tsquery('english', 'Apple & Inc')
  AND d.document_category = 'stock_overview'
  AND d.extracted_date BETWEEN '2022-01-01' AND '2025-12-31'
ORDER BY relevance DESC, d.extracted_date DESC
LIMIT 50;
```

---

## Folder Structure

```
backend/
  src/
    search/
      search.service.ts        // Main search orchestration
      query-parser.ts          // Parse user query syntax
      query-builder.ts         // Build SQL from ParsedQuery
      highlighter.ts           // Snippet generation
      facets.ts                // Generate filter counts

    routes/
      search.route.ts

shared/
  src/
    api/
      schemas/
        search.ts              // SearchRequestSchema, SearchResponseSchema
```

---

## Search Service Interface

```typescript
interface SearchService {
    search(query: string, options: SearchOptions): Promise<SearchResults>;
    getFacets(query: string): Promise<SearchFacets>;
    suggestCompanies(prefix: string): Promise<string[]>;
}

interface SearchOptions {
    limit?: number;
    offset?: number;
    sortBy?: 'relevance' | 'date' | 'filename';
    sortOrder?: 'asc' | 'desc';
}

interface SearchResults {
    total: number;
    results: SearchResult[];
    facets: SearchFacets;
    query: ParsedQuery;
}

interface SearchResult {
    document_id: string;
    filename: string;
    folder_path: string;
    extracted_date?: Date;
    category?: string;
    snippet: string; // Highlighted excerpt
    relevance: number;
    thumbnail_url?: string;
}

interface SearchFacets {
    categories: { name: string; count: number }[];
    companies: { name: string; count: number }[];
    years: { year: number; count: number }[];
    tags: { name: string; count: number }[];
}
```

---

## Query Examples

### Example 1: Simple Text Search

```
User input: "dividend payment"

Parsed:
{
  fullText: "dividend payment"
}

SQL WHERE:
ocr.text_vector @@ to_tsquery('english', 'dividend & payment')
```

### Example 2: Complex Query

```
User input: category:stock_overview date:2023-01-01..2023-12-31 Apple Microsoft

Parsed:
{
  fullText: "Apple Microsoft",
  dateRange: { start: 2023-01-01, end: 2023-12-31 },
  categories: ["stock_overview"]
}

SQL WHERE:
ocr.text_vector @@ to_tsquery('english', 'Apple | Microsoft')
AND d.document_category = 'stock_overview'
AND d.extracted_date BETWEEN '2023-01-01' AND '2023-12-31'
```

### Example 3: Fuzzy Company Search

```
User input: company:Aple (typo)

Autocorrect/fuzzy match → "Apple"

Lookup in document_tags or ocr_results.metadata -> companies
```

---

## Faceted Search

Facets provide counts for filtering:

```json
{
    "facets": {
        "categories": [
            { "name": "stock_overview", "count": 45 },
            { "name": "dividend_statement", "count": 12 },
            { "name": "transaction_receipt", "count": 8 }
        ],
        "companies": [
            { "name": "Apple Inc.", "count": 23 },
            { "name": "Microsoft Corp.", "count": 18 }
        ],
        "years": [
            { "year": 2023, "count": 34 },
            { "year": 2024, "count": 28 }
        ]
    }
}
```

UI can show these as filter chips/checkboxes.

---

## Autocomplete / Suggestions

### Company Autocomplete

```
GET /api/search/suggest/companies?q=App
Response: ["Apple Inc.", "Applied Materials", "Applovin Corp."]
```

Powered by:

```sql
SELECT DISTINCT jsonb_array_elements_text(metadata->'companies') as company
FROM ocr_results
WHERE metadata->'companies' ? :prefix
LIMIT 10;
```

### Recent Searches

Store user's recent searches for quick access (client-side or DB-backed).

---

## Highlighting and Snippets

Use `ts_headline` to generate context snippets:

```sql
ts_headline(
  'english',
  ocr.raw_text,
  to_tsquery('english', 'Apple'),
  'StartSel=<mark>, StopSel=</mark>, MaxWords=50, MinWords=25'
)
```

Result:

```
"...portfolio holdings include <mark>Apple</mark> Inc. (AAPL) with 150 shares valued at..."
```

---

## Performance Optimizations

### Indexes (Already in Plan 02)

```sql
CREATE INDEX idx_ocr_text_search ON ocr_results USING GIN(text_vector);
CREATE INDEX idx_documents_category ON documents(document_category);
CREATE INDEX idx_documents_extracted_date ON documents(extracted_date);
```

### Query Caching

- Cache common queries (e.g., "all documents in folder X")
- Invalidate on document updates

### Pagination

- Limit results to 50 per page
- Use cursor-based pagination for large result sets

---

## API Endpoints

### Main Search

```
GET /api/search?q=category:stock_overview Apple date:2023
Response: {
  total: 23,
  results: [...],
  facets: {...},
  query: {...}
}
```

### Facets Only

```
GET /api/search/facets?q=Apple
Response: { facets: {...} }
```

### Suggestions

```
GET /api/search/suggest/companies?q=App
Response: ["Apple Inc.", "Applied Materials"]
```

---

## Advanced Features (Future)

### Semantic Search (pgvector)

- Generate embeddings for OCR text
- Store in `ocr_results.embedding` (vector column)
- Query: `ORDER BY embedding <-> query_embedding LIMIT 10`
- Allows: "Find documents similar to this one"

### Saved Searches

- User creates complex query
- Saves with name
- Can be re-run or set as alert

### Search Alerts

- User defines search query
- Notified when new documents match
- "Alert me when new Apple stock documents are added"

---

## Error Handling

### Invalid Query Syntax

- Return helpful error: "Invalid date format, expected YYYY-MM-DD"
- Suggest corrections

### No Results

- Show suggestions: "Did you mean 'Apple' instead of 'Aple'?"
- Show recent searches
- Show popular searches

### Timeout

- If query takes >5s, cancel and suggest narrowing search

---

## Acceptance Criteria

- Search API endpoint works
- Full-text search returns relevant results
- Date range filtering works
- Category filtering works
- Facets are generated correctly
- Search results include highlighted snippets
- Query parser handles complex queries
- Performance is <100ms for typical queries
- Autocomplete suggests companies

---

## Future Enhancements

- Multi-language support
- Boolean operators (AND, OR, NOT)
- Proximity search ("Apple" within 5 words of "stock")
- Image similarity search (visual features)
- Export search results (CSV, JSON)
