
# Plan 01 — Initial Monorepo Setup

## Goal
Set up a clean, scalable Nx monorepo with:
- **backend** (Node.js + Fastify)
- **apps/web** (React + Vite)
- **apps/android** (Kotlin + Jetpack Compose) — separate Gradle project, linked but not managed by Nx
- **shared** (TypeScript library for types and schemas)

No application logic is required at this stage.  
The goal is **correct structure, tooling, and type-safety foundations**.

---

## Tooling & Constraints
- Package manager: pnpm
- Monorepo: Nx (latest stable)
- Language: TypeScript (backend, web, shared), Kotlin (Android)
- ESM-first where possible
- Strict TypeScript settings
- Testing: Vitest

---

## Steps

### 1. Initialize Nx Workspace
- Create an empty Nx workspace with pnpm
- Configure workspace for TypeScript
- Enable caching and task pipelines

```bash
npx create-nx-workspace@latest reverie --preset=ts --pm=pnpm
```

Expected outcome:
- `nx.json`
- `tsconfig.base.json`
- Root `package.json`
- `.env.example` with all required env vars

---

### 2. Create Projects

#### Backend
- Name: `backend`
- Location: `backend/`
- Type: Node.js application
- Entry point: `src/main.ts`
- Build: esbuild (via Nx)
- Dev: `nx serve backend`

```bash
nx g @nx/node:application backend --directory=backend --bundler=esbuild
```

#### Web App
- Name: `web`
- Location: `apps/web/`
- Type: React + Vite application
- Entry point: `src/main.tsx`
- Build: Vite
- Dev: `nx serve web`

```bash
nx g @nx/react:application web --directory=apps/web --bundler=vite --style=css
```

#### Shared Library
- Name: `shared`
- Location: `shared/`
- Type: TypeScript library (publishable)
- Purpose:
  - Shared types
  - Zod validation schemas
  - API contracts
- Must be usable in:
  - Node.js (backend)
  - Browser (web app)

```bash
nx g @nx/js:library shared --directory=shared --bundler=tsc --publishable --importPath=@reverie/shared
```

#### Android App
- Name: `android`
- Location: `apps/android/`
- Type: Kotlin + Jetpack Compose
- Build: Gradle
- Note: Not managed by Nx (separate Gradle project), but lives in the monorepo

Created manually with Android Studio or command line. Nx doesn't manage it, but it coexists in the repo.

---

### 3. TypeScript Configuration

Base `tsconfig.base.json`:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "paths": {
      "@reverie/shared": ["shared/src/index.ts"]
    }
  }
}
```

---

### 4. Environment Configuration

Create `.env.example` at root:
```bash
# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/reverie

# Redis
REDIS_URL=redis://localhost:6379

# Storage
STORAGE_PROVIDER=local
STORAGE_LOCAL_ROOT=/path/to/files

# S3 (optional, if STORAGE_PROVIDER=s3)
STORAGE_S3_BUCKET=reverie
STORAGE_S3_ENDPOINT=http://localhost:9000
STORAGE_S3_ACCESS_KEY=minioadmin
STORAGE_S3_SECRET_KEY=minioadmin

# OpenAI
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o-mini

# Server
PORT=3000
HOST=0.0.0.0

# WebSocket
WS_ENABLED=true
WS_CORS_ORIGIN=http://localhost:5173

# Job Queue
JOB_CONCURRENCY_OCR=2
JOB_CONCURRENCY_THUMBNAIL=4
JOB_CONCURRENCY_LLM=1
```

---

### 5. Linting & Formatting

ESLint configured for:
- TypeScript
- React (web app)
- Node.js (backend)

Prettier for consistent formatting.

Nx provides default ESLint configuration. Customize as needed:
```bash
nx g @nx/eslint:lint backend
nx g @nx/eslint:lint web
nx g @nx/eslint:lint shared
```

---

### 6. Testing Setup

Configure Vitest for all TypeScript projects:
```bash
nx g @nx/vite:vitest backend
nx g @nx/vite:vitest web  
nx g @nx/vite:vitest shared
```

---

### 7. Nx Configuration

Update `nx.json` for task pipelines:
```json
{
  "targetDefaults": {
    "build": {
      "dependsOn": ["^build"],
      "cache": true
    },
    "test": {
      "cache": true
    },
    "lint": {
      "cache": true
    }
  },
  "defaultBase": "main"
}
```

---

## Project Structure (Final)

```
reverie/
├── nx.json
├── package.json
├── pnpm-lock.yaml
├── tsconfig.base.json
├── .env.example
├── .gitignore
├── .prettierrc
├── eslint.config.js
│
├── backend/
│   ├── project.json
│   ├── tsconfig.json
│   ├── tsconfig.app.json
│   ├── tsconfig.spec.json
│   └── src/
│       └── main.ts
│
├── shared/
│   ├── project.json
│   ├── tsconfig.json
│   ├── tsconfig.lib.json
│   ├── tsconfig.spec.json
│   └── src/
│       └── index.ts
│
├── apps/
│   ├── web/
│   │   ├── project.json
│   │   ├── tsconfig.json
│   │   ├── vite.config.ts
│   │   ├── index.html
│   │   └── src/
│   │       ├── main.tsx
│   │       └── App.tsx
│   │
│   └── android/
│       ├── build.gradle.kts
│       ├── settings.gradle.kts
│       ├── gradle.properties
│       └── app/
│           ├── build.gradle.kts
│           └── src/main/
│               ├── AndroidManifest.xml
│               └── java/com/reverie/app/
│                   └── MainActivity.kt
```

---

## Useful Nx Commands

```bash
# View project graph
nx graph

# Build all projects
nx run-many -t build

# Build specific project
nx build backend

# Run dev server
nx serve backend
nx serve web

# Run tests
nx test shared
nx run-many -t test

# Run only affected (changed) projects
nx affected -t test
nx affected -t build

# Lint
nx lint backend
nx run-many -t lint
```

---

## Acceptance Criteria
- `pnpm install` works from root
- `nx graph` shows backend, web, and shared projects
- Backend builds and runs: `nx serve backend`
- Web app builds and runs: `nx serve web`
- Shared library imports work in backend and web: `import { ... } from '@reverie/shared'`
- Android project builds: `cd apps/android && ./gradlew build`
- `.env.example` documents all required environment variables
- `nx test shared` runs Vitest successfully (even with placeholder test)
- All projects pass lint: `nx run-many -t lint`

